---
title: "RRI+UNST"
format: 
  html:
    toc: true
    toc-depth: 3
    number-sections: true
  pdf:
    toc: true
    toc-depth: 3
    number-sections: true
---

# 統合モデル（洪水流）

RRI_UNST-2Dプログラムマニュアル

Ver.0.0.0

（2025.1）

# 目次

# はじめに

本資料は統合モデル（RRI + UNST洪水流）の仕様書およびマニュアルである。モデルの概要や入出力データの形式などを解説する。

入力データの作成方法例などは別資料の「統合モデル（RRI+UNST洪水流）インプットデータ作成例」を参照いただきたい。

## 更新履歴

# モデル概要

## 1. 実行環境・使用ソフト

## 2. RRI

### 2.1. RRIとは

### 2.2. ファイル構成

RRIのプロジェクトフォルダの構成（最小構成）は以下の通りである。詳細はICHARMが提供するRRIのマニュアルを参照いただきたい。

```
RRIプロジェクトフォルダ
├── topo
│   ├── acc.txt
│   ├── adem.txt
│   └── adir.txt
├── rain
│   └── rain.dat
├── out
├── RRI_input.txt
└── 0_rri_1_4_2_7.exe *
```

実行ファイル0_rri_1_4_2_7.exe（25/01時点）は以下のソースファイル群をコンパイルして作成する。ソースファイルはRRI-CUI > source > 1.4.2.7に格納されている。

```
source
├── RRI.f90
├── RRI_Bound.f90
├── RRI_Break.f90
├── RRI_Dam.f90
├── RRI_Div.f90
├── RRI_DT_Check.f90
├── RRI_Evp.f90
├── RRI_GW.f90
├── RRI_Infilt.f90
├── RRI_Mod.f90
├── RRI_Mod2.f90
├── RRI_Mod_Dam.f90
├── RRI_Mod_Tecout.f90
├── RRI_Read.f90
├── RRI_Riv.f90
├── RRI_RivSlo.f90
├── RRI_Section.f90
├── RRI_Slope.f90
├── RRI_Sub.f90
├── RRI_Tecout.f90
└── RRI_TSAS.f90
```

Makefile

### 参考文献

1) ICHARM：降雨流出氾濫モデル（RRIモデル）＜https://www.pwri.go.jp/icharm/research/rri/index_j.html＞

## 3. UNST

### 3.1. UNSTとは

UNSTとは、川池1)により開発された、非構造格子を使用可能とする二次元氾濫解析モデルである。非構造格子とは、不規則な形状または配列を有する格子のことであり、構造格子では表現が困難な複雑な形状を表現可能とする（図3-1）。

![構造格子と非構造格子](図3-1_構造格子と非構造格子.jpg)

### 3.2. 基礎式

UNSTの基礎式について解説する。詳細は川池1)を参照いただきたい。

#### 二次元不定流計算

UNSTの二次元不定流計算の基礎式は以下の浅水方程式である。

$$\frac{\partial h}{\partial t} + \frac{\partial M}{\partial x} + \frac{\partial N}{\partial y} = 0 \tag{1}$$

$$\frac{\partial M}{\partial t} + \frac{\partial(uM)}{\partial x} + \frac{\partial(vM)}{\partial y} = -gh\frac{\partial H}{\partial x} - \frac{\tau_{bx}}{\rho_w} \tag{2}$$

$$\frac{\partial N}{\partial t} + \frac{\partial(uN)}{\partial x} + \frac{\partial(vN)}{\partial y} = -gh\frac{\partial H}{\partial y} - \frac{\tau_{by}}{\rho_w} \tag{3}$$

$$\tau_{bx} = \frac{\rho_w g n^2 u\sqrt{u^2+v^2}}{h^{1/3}} \tag{4}$$

$$\tau_{by} = \frac{\rho_w g n^2 v\sqrt{u^2+v^2}}{h^{1/3}} \tag{5}$$

ここで各変数は以下の通りである。

$h$：水深、$H$：水位、$u$：$x$方向の流速、$v$：$y$方向の流速  
$M$：$x$方向の流量フラックス（$M=uh$）  
$N$：$y$方向の流量フラックス（$N=vh$）  
$\tau_{bx}$：水底面でのせん断応力の$x$方向成分  
$\tau_{by}$：水底面でのせん断応力の$y$方向成分  
$\rho_w$：水の密度、$n$：粗度係数、$g$：重力加速度

このとき各未知量は次のように定義される（図3-2）。

- 全領域にデカルト座標軸（$x$軸、$y$軸）を設定
- デカルト座標系における各方向の流速$(u,v)$・流量フラックス$(M,N)$は格子境界（辺の中点）で定義
- 水深$h$は格子の図心（≒重心）で定義

![モデルの概要1](図3-2_モデルの概要1.jpg)

計算はLeap-Flog法を用いて陽的に進める。連続式の差分式は以下の式を用いる。

$$\frac{h_i^{n+3/2} - h_i^{n+1/2}}{2\Delta t} + \frac{1}{A_i}\sum_{l=1}^{m_i}\{M_l^{n+1}(\Delta y)_l - N_l^{n+1}(\Delta x)_l\} = 0 \tag{6}$$

ここで各変数は以下の通りである（図3-3）。なお、上付き添え字は時間ステップである。

$h_i$：格子$i$の水深  
$m_i$：格子$i$を囲む辺の数  
$A_i$：検査面$i$  
$M_l$：辺$l$上の$x$方向の流量フラックス  
$N_l$：辺$l$上の$y$方向の流量フラックス  
$(\Delta x)_l$：辺$l$上での両端の点の$x$座標の差  
$(\Delta y)_l$：辺$l$上での両端の点の$y$座標の差

運動量式について、格子$i$と格子$j$に挟まれた格子辺$L$における計算には以下の差分式を用いる。

（$x$方向）
$$\frac{M_L^{n+2} - M_L^{n}}{2\Delta t} + T_1 + T_2 = -g\hat{h}_L (∇H)_x - \frac{gn^2_L \sqrt{(u_L^{n+1})^2+(v_L^{n+1})^2}u_L^{n+1}}{(\hat{h}_L^{n+1})^{4/3}} \tag{7}$$

（$y$方向）
$$\frac{N_L^{n+2} - N_L^{n}}{2\Delta t} + T_1 + T_2 = -g\hat{h}_L (∇H)_y - \frac{gn^2_L \sqrt{(u_L^{n+1})^2+(v_L^{n+1})^2}v_L^{n+1}}{(\hat{h}_L^{n+1})^{4/3}} \tag{8}$$

ここで各変数は以下の通りである。

$M_L$：格子辺$L$上の$x$方向の流量フラックス  
$N_L$：格子辺$L$上の$y$方向の流量フラックス  
$(∇H)_x$：格子$i$と格子$j$間の水面勾配$∇H$の$x$方向成分  
$(∇H)_y$：格子$i$と格子$j$間の水面勾配$∇H$の$y$方向成分  
$u_L$：格子辺$L$上の$x$方向の流速  
$v_L$：格子辺$L$上の$y$方向の流速  
$\hat{h}_L$：格子辺$L$上の水深  
$T_1$, $T_2$：(2)式の移流項（左辺第2項、第3項）  
$T_1$, $T_2$：(3)式の移流項（左辺第2項、第3項）

検査面について$T_1+T_2$と$T_1+T_2$は以下のように計算する。

$$T_1+T_2 = \frac{1}{A_{cv}}\sum_{l=1}^{m'}\{(u_l\hat{M}_l)(\Delta y)_l-(v_l\hat{M}_l)(\Delta x)_l\} \tag{9}$$

$$T_1+T_2 = \frac{1}{A_{cv}}\sum_{l=1}^{m'}\{(u_l\hat{N}_l)(\Delta y)_l-(v_l\hat{N}_l)(\Delta x)_l\} \tag{10}$$

ここで各変数は以下の通りである。

$A_{cv}$：検査面の面積（2格子の面積の和）  
$m'$：検査面を囲む辺の数  
$u_l$, $v_l$：辺$l$上での流速  
$(\Delta x)_l$：辺$l$の両端の点の$x$座標の差  
$(\Delta y)_l$：辺$l$の両端の点の$y$座標の差  
$\hat{M}$, $\hat{N}$：格子の重心上の流量フラックス

格子辺上の流速方向にしたがって上流側の補間流量フラックスを使用
$\hat{M}$, $\hat{N}$は格子辺上の流量フラックスから補間して求める。
$m$角形の格子において、

$$\hat{M} = \frac{\frac{1}{d_1}M_1+\cdots+\frac{1}{d_m}M_m}{\frac{1}{d_1}+\cdots+\frac{1}{d_m}} \tag{11}$$

$$\hat{N} = \frac{\frac{1}{d_1}N_1+\cdots+\frac{1}{d_m}N_m}{\frac{1}{d_1}+\cdots+\frac{1}{d_m}} \tag{12}$$

ここで各変数は以下の通りである。

$d_1$, $d_2$, …, $d_m$：各辺の中点とこの格子の重心との距離  
$M_1$, $M_2$, …, $M_m$：各辺上の$x$方向の流量フラックス  
$N_1$, $N_2$, …, $N_m$：各辺上の$y$方向の流量フラックス

格子$i$と格子$j$間の水面勾配$∇H$の各方向成分$(∇H)_x$, $(∇H)_y$は以下のように計算する。

$$(∇H)_x = \frac{H_j-H_i}{D_L} \cdot \frac{x_j-x_i}{D_L} \tag{13}$$

$$(∇H)_y = \frac{H_j-H_i}{D_L} \cdot \frac{y_j-y_i}{D_L} \tag{14}$$

ここで各変数は以下の通りである。

$H_i$：格子$i$の水位  
$H_j$：格子$j$の水位  
$(x_i,y_i)$：格子$i$の図心の座標  
$(x_j,y_j)$：格子$j$の図心の座標  
$D_L$：格子$i$と格子$j$の図心間距離（$D_L = \sqrt{(x_j-x_i)^2+(y_j-y_i)^2}$）

また、格子辺上の水深$\hat{h}_L$および粗度係数$\hat{n}_L$は格子辺$L$を形成する2つの格子（格子$i$、格子$j$）より補間して求める。格子の図心と辺$L$の中点の距離の逆数に比例する形で補完する。

$$\hat{h}_L = \frac{\frac{1}{d_i}h_i+\frac{1}{d_j}h_j}{\frac{1}{d_i}+\frac{1}{d_j}} = \frac{d_j h_i + d_i h_j}{d_i+d_j} \tag{15}$$

$$\hat{n}_L = \frac{\frac{1}{d_i}n_i+\frac{1}{d_j}n_j}{\frac{1}{d_i}+\frac{1}{d_j}} = \frac{d_j n_i + d_i n_j}{d_i+d_j} \tag{16}$$

ここで各変数は以下の通りである。

$h_i$：格子$i$の水深  
$h_j$：格子$j$の水深  
$n_i$：格子$i$の粗度係数  
$n_j$：格子$j$の粗度係数  
$d_i$：格子$i$の図心と辺$L$の中点の距離  
$d_j$：格子$j$の図心と辺$L$の中点の距離

## 4. 統合モデル （RRI + UNST洪水流）

## 4.1. 統合モデル RRI + UNST 洪水流とは

## 4.2. ファイル構成

## 5. UNSTインプットデータ

## 5.1. 必須データ

### 5.1.1. 計算格子：node.dat，link.dat，mesh.dat

### 5.1.2. 標高値：bs.dat

### 5.1.3. 格子属性：inf.dat

### 5.1.4. 粗度係数：rn.dat

### 5.1.5. 降雨：rain.dat

### 5.1.6. 降雨-座標対応表：mesh2ij.dat

### 5.1.7. 流入量：qin.dat

## 5.2. 植生抵抗データ

### 5.2.1. 倒伏を考慮しない植生抵抗モデル：planta.dat，plantD.dat

### 5.2.2. 倒伏を考慮する植生抵抗モデル：plantF.dat，plantN.dat

## 5.3. 田んぼダムデータ

### 5.3.1. 田んぼ id：paddy.dat

### 5.3.2. 排水関連パラメータ：pqout.dat

### 5.3.3. 田んぼダムパラメータ：paddy_param.dat

```
paddy_param.dat

lh= 畦畔高（m）
wh1= 水管理用堰板の高さ（m）
wh2= 機能一体型の器具の高さ（m）
ww1= 器具の切欠幅（m）
ww2= 落水枡の排水口幅（m）
ca= 器具の中心角（度）
wtyp= 器具のタイプ 1:一体型 2:分離型 0:田んぼダムなし
dld= 畦畔天端と器具上端の高さの差（m）
dd= 器具の穴直径（m）
dh= 田面から器具の穴中心までの高さ（m）
p_data= 排水管の直径（m）
ph= 排水管中心までの高さ（m）
```

例）
```
lh= 0.3
wh1= 0.03
wh2= 0.1
ww1= 0.3
ww2= 0.1
ca= 45
wtyp= 1
dld= 0.1
dd= 0.05
dh= 0.3
p_data= 0.15
ph= 0.3
```

参考）

![田んぼダム各種パラメータ（農林水産省 農村振興局 整備部：水田流出簡易計算プログラムVer.0.0（ryuuiki_tisui-3.xlsm 変数説明シート）より引用）](図5-5_田んぼダムパラメータ.jpg)

## 5.4. 下水道・圃場データ

### 5.4.1. 下水道・圃場 id：inf_dr.dat

### 5.4.2. 下水道・圃場パラメータ：drain.dat

## 5.5. その他

### 5.5.1. 線盛土：morido.dat（未検証）

### 5.5.2. 排水処理（境界）：dsmesh.dat（開発中）

### 5.5.3. カルバート・樋門（樋管）・ポンプ：drfacility.dat （調整中）

### 5.5.4. 浸透モデル：unst_infilt.dat

浸透モデルのパラメータは以下の通りである。

$unst_soildepth$：浸透モデルの適用深度（m）
$unst_ksv$：浸透モデルの透水係数（m/s）
$unst_infilt_limit$：浸透モデルの透水係数の上限値（m/s）


インプットファイルのフォーマットは以下の通りである。

```
13
inf　　粗度　土層圧　gamma    ksv    faif
1   0.067d0 0.5d0 0.05d0 0.02d0 0.01d0  ! 氾濫域
24  0.030d0   ! 河川
63  0.035d0   ! 田んぼダムを考慮しない水田
71  0.035d0   ! 田んぼダム(added by k.yamamura)
25  0.025d0   ! ポンプ
26  0.025d0   ! ため池
31  0.067d0   ! 事務所
32  0.067d0   ! 住宅
4   0.067d0   ! 学校
5   0.025d0   ! 公園
6   0.035d0   ! 農地
7   0.100d0   ! 山地
8   0.043d0   ! 道路
```

粗度設定ファイルに、浸透モデルの適用深度、透水係数、透水係数の上限値を追加することで設定する。
今までの形式のファイルでも変更することなく、浸透モデルなしで使用できる。

## 6. RRI（CUI）の実行

## 6.1. RRI_Input ファイルの管理

## 6.2. 実行

## 7. UNSTの実行

## 7.1. cntl ファイルの管理

## 7.2. 実行

## 8. 統合モデル （RRI + UNST洪水流）の実行

## 8.1. cntl.dat，RRI_Input.txt の管理

## 8.2. 実行

## 9. 出力結果

## 9.1. 時系列別浸水深：h.dat（h.csv）

## 9.2. 最大浸水深：hmax.dat（hmaxdata.csv）

## 9.3. 時系列別x方向の流速：uum.dat

## 9.4. x方向の最大流速：uummax.dat

## 9.5. 時系列別y方向の流速：vvm.dat

## 9.6. y方向の最大流速：vvmmax.dat

## 9.7. 時系列別流量：q.dat

## 9.8. 時系列別水収支：unststrage.dat

## 9.9. 田んぼダム 時間遅れ排水量：dhp.dat

## 9.10. 田んぼダム 田水深：paddyh.dat

## 9.11. 田んぼダム 流入量：paddyq.dat

## 10. 出力結果の可視化＜執筆中＞

## 10.1. 図示

### 10.1.1. 最大浸水深

### 10.1.2. 最大流速

最大流速の図示には各時系列のuumとvvmから流速を求めた後、最大値を抽出する必要がある。流速$u$は以下の式で定義される。

$$u(i,t)=\sqrt{uum(i,t)^2 + vvm(i,t)^2}$$

最大流速算出後は最大浸水深と概ね同様である。

![図10-4 最大流速の可視化](図10-4_最大流速の可視化.jpg)

### 10.1.3. 最大流体力

最大流体力の図示には最大流速同様、各時系列の流体力を算出後、最大値を抽出する必要がある。流体力$u^2h$は以下の式で定義される。

$$u^2h = (uum^2 + vvm^2) \times h$$

最大流体力算出後は最大浸水深と概ね同様である。

![図10-5 最大流体力の可視化](図10-5_最大流体力の可視化.jpg)

## 10.2. 動画

### 10.2.1. 浸水深，流速，流体力

## 11. 関連コード一覧

### 11.1. Fortran

### 11.2. Python

## 12. おわりに

## 13. 付録

### 13.1. Python環境 導入方法

### 13.2. Microsoft Visual Studio（Fortran環境） 導入方法

### 13.3. QGIS 導入・操作方法

